#!/usr/bin/env bash
set -e

CWD="${0%/*}"
LIB=$CWD/../lib
OUT=$CWD/../out
OUTPUT_FORMAT=json
PORT=2000

# parse arguments
while [[ "$#" > 0 ]]; do case $1 in
  -o|--output) OUTPUT_FORMAT="$2"; shift;;
  -p|--port) PORT="$2"; shift;;
esac; shift; done


# Pre check output format before doing something
if ! [[ "$OUTPUT_FORMAT" =~ ^(json|env|yaml|yml)$ ]]; then
  echo "output format $OUTPUT_FORMAT is not supported"
  exit 1
fi

mkdir -p $OUT

cd $LIB/dss-deploy/
source bin/deploy-all
cd -

# Output functions file
source $CWD/output

case "$OUTPUT_FORMAT" in
  json)
    write_json "$OUT/addresses.json"
    ;;
  yaml|yml)
    write_yaml "$OUT/addresses.yaml"
    ;;
  env)
    write_env "$OUT/addresses"
    ;;
esac

$CWD/collect-abis
